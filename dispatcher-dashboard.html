<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BanTrans - Dispatcher Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar h1 {
            font-size: 24px;
        }

        .navbar-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            font-size: 14px;
        }

        .btn-logout {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .card h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .queue-section {
            margin-bottom: 30px;
        }

        .route-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .route-title {
            font-size: 18px;
            font-weight: 600;
        }

        .trip-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            position: relative;
        }

        .trip-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .queue-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .trip-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            font-size: 13px;
        }

        .info-label {
            color: #666;
            font-size: 11px;
            margin-bottom: 4px;
        }

        .info-value {
            color: #333;
            font-weight: 600;
        }

        .trip-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-info {
            background: #2196F3;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .alert-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-boarding {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-waiting {
            background: #fff3e0;
            color: #e65100;
        }

        .status-full {
            background: #ffebee;
            color: #c62828;
        }

        .status-departed {
            background: #e1f5fe;
            color: #01579b;
        }

        .status-paid {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-bar input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-type-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .search-type-tab {
            padding: 8px 16px;
            background: #f5f5f5;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .search-type-tab.active {
            background: #667eea;
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f9f9f9;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .trip-info {
                grid-template-columns: 1fr;
            }

            .tabs {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>üöå BanTrans TMS - Dispatcher</h1>
        <div class="navbar-right">
            <div class="user-info">
                <div id="userName"></div>
                <div style="font-size: 12px; opacity: 0.8;">Dispatcher</div>
            </div>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('queue')">Queue Status</button>
            <button class="tab" onclick="showTab('createTrip')">Create Trip</button>
            <button class="tab" onclick="showTab('walkIn')">Walk-in Booking</button>
            <button class="tab" onclick="showTab('search')">Search Bookings</button>
            <button class="tab" onclick="showTab('activeBookings')">Active Bookings</button>
            <button class="tab" onclick="showTab('monitoring')">Monitoring</button>
            <button class="tab" onclick="showTab('cancellations')">Cancellations</button>
            <button class="tab" onclick="showTab('resources')">Resources</button>
        </div>

        <div id="alert-container"></div>

        <!-- Queue Status Tab -->
        <div id="queue" class="tab-content active">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Queue Status - All Routes</h2>
                    <button class="btn btn-primary" onclick="loadQueue()">üîÑ Refresh</button>
                </div>
                <div id="queue-container"></div>
            </div>
        </div>

        <!-- Create Trip Tab -->
        <div id="createTrip" class="tab-content">
            <div class="card">
                <h2>Create New Trip</h2>
                <form id="createTripForm">
                    <div class="form-group">
                        <label>Select Route</label>
                        <select id="tripRoute" required></select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Select Vehicle</label>
                            <select id="tripVehicle" required></select>
                        </div>

                        <div class="form-group">
                            <label>Select Driver</label>
                            <select id="tripDriver" required></select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Estimated Departure</label>
                        <input type="datetime-local" id="tripDeparture" required>
                    </div>

                    <button type="submit" class="btn btn-primary">Create Trip</button>
                </form>
            </div>
        </div>

        <!-- Walk-in Booking Tab -->
        <div id="walkIn" class="tab-content">
            <div class="card">
                <h2>Walk-in Booking</h2>
                <form id="walkInForm">
                    <div class="form-group">
                        <label>Select Trip</label>
                        <select id="walkInTrip" required></select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" id="walkInFirstname" required>
                        </div>

                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" id="walkInLastname" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="walkInEmail" required>
                        </div>

                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="walkInPhone" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Address</label>
                        <textarea id="walkInAddress" rows="2" required></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Number of Seats</label>
                            <input type="number" id="walkInSeats" min="1" max="10" value="1" required>
                        </div>

                        <div class="form-group">
                            <label>Payment Method</label>
                            <select id="walkInPayment" required>
                                <option value="cash">Cash</option>
                                <option value="gcash">GCash</option>
                                <option value="paymaya">PayMaya</option>
                                <option value="terminal">Terminal</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Payment Reference</label>
                        <input type="text" id="walkInPaymentRef" required>
                    </div>

                    <button type="submit" class="btn btn-success">Create Booking</button>
                </form>
            </div>
        </div>

        <!-- Search Bookings Tab -->
        <div id="search" class="tab-content">
            <div class="card">
                <h2>Search Bookings</h2>
                
                <div class="search-type-tabs">
                    <button class="search-type-tab active" onclick="setSearchType('name')">By Name</button>
                    <button class="search-type-tab" onclick="setSearchType('email')">By Email</button>
                    <button class="search-type-tab" onclick="setSearchType('ticket')">By Ticket</button>
                </div>

                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Enter search term...">
                    <button class="btn btn-primary" onclick="searchBookings()">üîç Search</button>
                </div>

                <div id="search-results"></div>
            </div>
        </div>

        <!-- Active Bookings Tab -->
        <div id="activeBookings" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Active Bookings</h2>
                    <button class="btn btn-primary" onclick="loadActiveBookings()">üîÑ Refresh</button>
                </div>
                <div id="active-bookings-container"></div>
            </div>
        </div>

        <!-- Monitoring Tab -->
        <div id="monitoring" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Real-Time Monitoring</h2>
                    <button class="btn btn-primary" onclick="refreshMonitoring()">üîÑ Refresh All</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="liveQueueCount">0</div>
                        <div class="stat-label">Trips in Queue</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="liveSeatsAvailable">0</div>
                        <div class="stat-label">Available Seats</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="liveRecentBookings">0</div>
                        <div class="stat-label">Recent Bookings (20min)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="liveActiveDrivers">0</div>
                        <div class="stat-label">Active Drivers</div>
                    </div>
                </div>

                <h3 style="margin: 20px 0 10px 0;">Recent Bookings</h3>
                <div id="monitoring-bookings"></div>
            </div>
        </div>

        <!-- Cancellations Tab -->
        <div id="cancellations" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Cancellation History</h2>
                    <button class="btn btn-primary" onclick="loadCancellations()">üîÑ Refresh</button>
                </div>
                <div id="cancellations-container"></div>
            </div>
        </div>

        <!-- Resources Tab -->
        <div id="resources" class="tab-content">
            <div class="card">
                <h2>Available Resources</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div>
                        <h3 style="margin-bottom: 15px;">Drivers</h3>
                        <div id="drivers-list"></div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 15px;">Vehicles</h3>
                        <div id="vehicles-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manifest Modal -->
    <div id="manifestModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Passenger Manifest</h2>
                <span class="modal-close" onclick="closeModal('manifestModal')">&times;</span>
            </div>
            <div id="manifest-content"></div>
        </div>
    </div>

    <!-- Reassign Vehicle Modal -->
    <div id="reassignVehicleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reassign Vehicle</h2>
                <span class="modal-close" onclick="closeModal('reassignVehicleModal')">&times;</span>
            </div>
            <form id="reassignVehicleForm">
                <input type="hidden" id="reassignTripId">
                <div class="form-group">
                    <label>Select New Vehicle</label>
                    <select id="reassignVehicleSelect" required></select>
                </div>
                <button type="submit" class="btn btn-primary">Reassign Vehicle</button>
            </form>
        </div>
    </div>

    <!-- Reassign Driver Modal -->
    <div id="reassignDriverModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reassign Driver</h2>
                <span class="modal-close" onclick="closeModal('reassignDriverModal')">&times;</span>
            </div>
            <form id="reassignDriverForm">
                <input type="hidden" id="reassignDriverTripId">
                <div class="form-group">
                    <label>Select New Driver</label>
                    <select id="reassignDriverSelect" required></select>
                </div>
                <button type="submit" class="btn btn-primary">Reassign Driver</button>
            </form>
        </div>
    </div>

    <!-- Cancel Booking Modal -->
    <div id="cancelBookingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Cancel Booking</h2>
                <span class="modal-close" onclick="closeModal('cancelBookingModal')">&times;</span>
            </div>
            <div id="cancel-booking-info"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-danger" onclick="confirmCancelBooking()">Confirm Cancel</button>
                <button class="btn" style="background: #ccc;" onclick="closeModal('cancelBookingModal')">Go Back</button>
            </div>
        </div>
    </div>

    <!-- Contact Modal -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Contact Information</h2>
                <span class="modal-close" onclick="closeModal('contactModal')">&times;</span>
            </div>
            <div id="contact-info"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5001/api';
        let token = localStorage.getItem('token');
        let user = JSON.parse(localStorage.getItem('user'));
        let currentSearchType = 'name';
        let currentCancelBookingId = null;

        if (!token || !user) {
            window.location.href = 'login.html';
        }

        document.getElementById('userName').textContent = `${user.firstname} ${user.lastname}`;

        // Initialize
        loadQueue();
        loadResources();
        loadFormData();

        // Auto-refresh monitoring every 30 seconds
        setInterval(() => {
            const activeTab = document.querySelector('.tab.active').textContent;
            if (activeTab.includes('Monitoring')) {
                refreshMonitoring();
            }
        }, 30000);

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'queue') loadQueue();
            if (tabName === 'createTrip') loadFormData();
            if (tabName === 'walkIn') loadBoardingTrips();
            if (tabName === 'activeBookings') loadActiveBookings();
            if (tabName === 'monitoring') refreshMonitoring();
            if (tabName === 'cancellations') loadCancellations();
            if (tabName === 'resources') loadResources();
        }

        async function loadQueue() {
            const container = document.getElementById('queue-container');
            container.innerHTML = '<div class="loading">Loading queue...</div>';

            try {
                const response = await fetch(`${API_URL}/dispatcher/queue`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    container.innerHTML = data.data.map(route => `
                        <div class="queue-section">
                            <div class="route-header">
                                <div class="route-title">${route.origin} ‚Üí ${route.destination}</div>
                                <div>${route.trips.length} trips in queue</div>
                            </div>
                            ${route.trips.map(trip => `
                                <div class="trip-card">
                                    <span class="queue-badge">Queue #${trip.queue_position}</span>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <h3>Trip #${trip.trip_id}</h3>
                                        <span class="status-badge status-${trip.trip_status}">${trip.trip_status.toUpperCase()}</span>
                                    </div>
                                    <div class="trip-info">
                                        <div class="info-item">
                                            <div class="info-label">Departure</div>
                                            <div class="info-value">${new Date(trip.estimated_departure_time).toLocaleString()}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Seats</div>
                                            <div class="info-value">${trip.seats_booked}/${trip.capacity}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Vehicle</div>
                                            <div class="info-value">${trip.vehicle_type} (${trip.plate_number})</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Driver</div>
                                            <div class="info-value">${trip.driver_name}</div>
                                        </div>
                                    </div>
                                    <div class="trip-actions">
                                        <button class="btn btn-primary btn-sm" onclick="viewManifest(${trip.trip_id})">üìã Manifest</button>
                                        <button class="btn btn-warning btn-sm" onclick="openReassignVehicle(${trip.trip_id})">üöó Reassign Vehicle</button>
                                        <button class="btn btn-info btn-sm" onclick="openReassignDriver(${trip.trip_id})">üë§ Reassign Driver</button>
                                        ${trip.queue_position === 1 && trip.seats_booked > 0 ? 
                                            `<button class="btn btn-success btn-sm" onclick="markDeparted(${trip.trip_id})">üöÄ Mark Departed</button>` : 
                                            ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>No trips in queue</h3></div>';
                }
            } catch (error) {
                console.error('Load queue error:', error);
                container.innerHTML = '<div class="alert alert-error">Error loading queue</div>';
            }
        }

        async function loadFormData() {
            try {
                const [routes, vehicles, drivers] = await Promise.all([
                    fetch(`${API_URL}/passenger/routes`).then(r => r.json()),
                    fetch(`${API_URL}/dispatcher/resources/vehicles`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).then(r => r.json()),
                    fetch(`${API_URL}/dispatcher/resources/drivers`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).then(r => r.json())
                ]);

                if (routes.success) {
                    const routeSelect = document.getElementById('tripRoute');
                    routeSelect.innerHTML = '<option value="">Select route...</option>' +
                        routes.data.map(r => `<option value="${r.route_id}">${r.origin} ‚Üí ${r.destination}</option>`).join('');
                }

                if (vehicles.success) {
                    const vehicleSelect = document.getElementById('tripVehicle');
                    vehicleSelect.innerHTML = '<option value="">Select vehicle...</option>' +
                        vehicles.data.filter(v => v.vehicle_status === 'available').map(v => 
                            `<option value="${v.vehicle_id}">${v.vehicle_type} - ${v.plate_number} (${v.capacity} seats)</option>`
                        ).join('');
                    
                    // Also populate reassign modal
                    const reassignSelect = document.getElementById('reassignVehicleSelect');
                    reassignSelect.innerHTML = '<option value="">Select vehicle...</option>' +
                        vehicles.data.filter(v => v.vehicle_status === 'available').map(v => 
                            `<option value="${v.vehicle_id}">${v.vehicle_type} - ${v.plate_number} (${v.capacity} seats)</option>`
                        ).join('');
                }

                if (drivers.success) {
                    const driverSelect = document.getElementById('tripDriver');
                    driverSelect.innerHTML = '<option value="">Select driver...</option>' +
                        drivers.data.filter(d => d.driver_status === 'available').map(d => 
                            `<option value="${d.user_id}">${d.driver_name}</option>`
                        ).join('');
                    
                    // Also populate reassign modal
                    const reassignSelect = document.getElementById('reassignDriverSelect');
                    reassignSelect.innerHTML = '<option value="">Select driver...</option>' +
                        drivers.data.filter(d => d.driver_status === 'available').map(d => 
                            `<option value="${d.user_id}">${d.driver_name}</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Load form data error:', error);
            }
        }

        document.getElementById('createTripForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const tripData = {
                route_id: parseInt(document.getElementById('tripRoute').value),
                vehicle_id: parseInt(document.getElementById('tripVehicle').value),
                driver_id: parseInt(document.getElementById('tripDriver').value),
                estimated_departure: document.getElementById('tripDeparture').value
            };

            try {
                const response = await fetch(`${API_URL}/dispatcher/trips`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(tripData)
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('‚úÖ Trip created successfully!', 'success');
                    document.getElementById('createTripForm').reset();
                    showTab('queue');
                } else {
                    showAlert(`‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Error creating trip', 'error');
            }
        });

        async function loadBoardingTrips() {
            try {
                const response = await fetch(`${API_URL}/passenger/trips/available`);
                const data = await response.json();

                if (data.success) {
                    const select = document.getElementById('walkInTrip');
                    select.innerHTML = '<option value="">Select trip...</option>' +
                        data.data.map(t => 
                            `<option value="${t.trip_id}">${t.origin} ‚Üí ${t.destination} (${t.seats_available} seats available)</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Load trips error:', error);
            }
        }

        document.getElementById('walkInForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const bookingData = {
                trip_id: parseInt(document.getElementById('walkInTrip').value),
                firstname: document.getElementById('walkInFirstname').value,
                lastname: document.getElementById('walkInLastname').value,
                email: document.getElementById('walkInEmail').value,
                phone: document.getElementById('walkInPhone').value,
                address: document.getElementById('walkInAddress').value,
                seat_count: parseInt(document.getElementById('walkInSeats').value),
                payment_method: document.getElementById('walkInPayment').value,
                payment_reference: document.getElementById('walkInPaymentRef').value
            };

            try {
                const response = await fetch(`${API_URL}/dispatcher/bookings/walk-in`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bookingData)
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`‚úÖ Booking created! Ticket: ${data.data.ticket_reference}`, 'success');
                    document.getElementById('walkInForm').reset();
                } else {
                    showAlert(`‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Error creating booking', 'error');
            }
        });

        function setSearchType(type) {
            currentSearchType = type;
            document.querySelectorAll('.search-type-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            const input = document.getElementById('searchInput');
            if (type === 'name') input.placeholder = 'Enter passenger name...';
            if (type === 'email') input.placeholder = 'Enter email address...';
            if (type === 'ticket') input.placeholder = 'Enter ticket reference...';
        }

        async function searchBookings() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) {
                showAlert('Please enter a search term', 'error');
                return;
            }

            const container = document.getElementById('search-results');
            container.innerHTML = '<div class="loading">Searching...</div>';

            try {
                let endpoint = '';
                if (currentSearchType === 'name') {
                    endpoint = `${API_URL}/dispatcher/bookings/search/name/${encodeURIComponent(searchTerm)}`;
                } else if (currentSearchType === 'email') {
                    endpoint = `${API_URL}/dispatcher/bookings/search/email/${encodeURIComponent(searchTerm)}`;
                } else if (currentSearchType === 'ticket') {
                    endpoint = `${API_URL}/dispatcher/bookings/search/ticket/${encodeURIComponent(searchTerm)}`;
                }

                const response = await fetch(endpoint, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success && (data.data.length > 0 || data.data.booking_id)) {
                    const bookings = Array.isArray(data.data) ? data.data : [data.data];
                    container.innerHTML = `
                        <div class="alert alert-success">Found ${bookings.length} booking(s)</div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Ticket</th>
                                    <th>Passenger</th>
                                    <th>Trip</th>
                                    <th>Seats</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${bookings.map(b => `
                                    <tr>
                                        <td>${b.ticket_reference}</td>
                                        <td>${b.passenger_name}<br><small>${b.passenger_phone}</small></td>
                                        <td>${b.origin} ‚Üí ${b.destination}<br><small>${new Date(b.estimated_departure_time).toLocaleString()}</small></td>
                                        <td>${b.seat_count}</td>
                                        <td><span class="status-badge status-${b.payment_status}">${b.payment_status}</span></td>
                                        <td>
                                            <button class="btn btn-info btn-sm" onclick="viewBookingDetails(${b.booking_id})">View</button>
                                            ${b.payment_status === 'paid' ? 
                                                `<button class="btn btn-danger btn-sm" onclick="openCancelBooking(${b.booking_id})">Cancel</button>` : 
                                                ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<div class="alert alert-info">No bookings found</div>';
                }
            } catch (error) {
                console.error('Search error:', error);
                container.innerHTML = '<div class="alert alert-error">Error searching bookings</div>';
            }
        }

        async function loadActiveBookings() {
            const container = document.getElementById('active-bookings-container');
            container.innerHTML = '<div class="loading">Loading bookings...</div>';

            try {
                const response = await fetch(`${API_URL}/dispatcher/bookings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Ticket</th>
                                    <th>Passenger</th>
                                    <th>Trip</th>
                                    <th>Seats</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.map(b => `
                                    <tr>
                                        <td>${b.ticket_reference}</td>
                                        <td>${b.passenger_name}<br><small>${b.passenger_email}</small></td>
                                        <td>${b.origin} ‚Üí ${b.destination}<br><small>${new Date(b.estimated_departure_time).toLocaleString()}</small></td>
                                        <td>${b.seat_count}</td>
                                        <td>${b.booking_type}</td>
                                        <td>‚Ç±${b.total_amount}</td>
                                        <td><span class="status-badge status-${b.trip_status}">${b.trip_status}</span></td>
                                        <td>
                                            <button class="btn btn-info btn-sm" onclick="viewPassengerContact(${b.booking_id})">Contact</button>
                                            <button class="btn btn-danger btn-sm" onclick="openCancelBooking(${b.booking_id})">Cancel</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<div class="empty-state">No active bookings</div>';
                }
            } catch (error) {
                console.error('Load bookings error:', error);
                container.innerHTML = '<div class="alert alert-error">Error loading bookings</div>';
            }
        }

        async function refreshMonitoring() {
            try {
                const [queue, bookings, drivers] = await Promise.all([
                    fetch(`${API_URL}/dispatcher/monitor/queue`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).then(r => r.json()),
                    fetch(`${API_URL}/dispatcher/monitor/bookings`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).then(r => r.json()),
                    fetch(`${API_URL}/dispatcher/resources/drivers`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).then(r => r.json())
                ]);

                if (queue.success) {
                    document.getElementById('liveQueueCount').textContent = queue.data.length;
                    const totalSeats = queue.data.reduce((sum, t) => sum + t.seats_available, 0);
                    document.getElementById('liveSeatsAvailable').textContent = totalSeats;
                }

                if (bookings.success) {
                    document.getElementById('liveRecentBookings').textContent = bookings.data.length;
                    
                    const container = document.getElementById('monitoring-bookings');
                    container.innerHTML = bookings.data.length > 0 ? `
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Passenger</th>
                                    <th>Destination</th>
                                    <th>Seats</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${bookings.data.map(b => `
                                    <tr>
                                        <td>${new Date(b.booking_date).toLocaleTimeString()}</td>
                                        <td>${b.passenger_name}</td>
                                        <td>${b.destination}</td>
                                        <td>${b.seat_count}</td>
                                        <td>‚Ç±${b.total_amount}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<div class="alert alert-info">No recent bookings</div>';
                }

                if (drivers.success) {
                    const activeDrivers = drivers.data.filter(d => d.driver_status === 'on_trip').length;
                    document.getElementById('liveActiveDrivers').textContent = activeDrivers;
                }
            } catch (error) {
                console.error('Refresh monitoring error:', error);
            }
        }

        async function loadCancellations() {
            const container = document.getElementById('cancellations-container');
            container.innerHTML = '<div class="loading">Loading cancellations...</div>';

            try {
                const response = await fetch(`${API_URL}/dispatcher/bookings/cancellations`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Ticket</th>
                                    <th>Passenger</th>
                                    <th>Trip</th>
                                    <th>Seats</th>
                                    <th>Amount</th>
                                    <th>Cancelled On</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.map(b => `
                                    <tr>
                                        <td>${b.ticket_reference}</td>
                                        <td>${b.passenger_name}<br><small>${b.passenger_email}</small></td>
                                        <td>${b.origin} ‚Üí ${b.destination}<br><small>${new Date(b.estimated_departure_time).toLocaleString()}</small></td>
                                        <td>${b.seat_count}</td>
                                        <td>‚Ç±${b.total_amount}</td>
                                        <td>${new Date(b.cancellation_date).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<div class="empty-state">No cancellations</div>';
                }
            } catch (error) {
                console.error('Load cancellations error:', error);
                container.innerHTML = '<div class="alert alert-error">Error loading cancellations</div>';
            }
        }

        async function viewManifest(tripId) {
            const modal = document.getElementById('manifestModal');
            const content = document.getElementById('manifest-content');
            
            modal.classList.add('active');
            content.innerHTML = '<div class="loading">Loading manifest...</div>';

            try {
                const response = await fetch(`${API_URL}/dispatcher/trips/${tripId}/manifest`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success) {
                    const manifest = data.data;
                    content.innerHTML = `
                        <div style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                            <h3>Trip #${manifest.trip_info.trip_id}</h3>
                            <p><strong>Route:</strong> ${manifest.trip_info.origin} ‚Üí ${manifest.trip_info.destination}</p>
                            <p><strong>Departure:</strong> ${new Date(manifest.trip_info.estimated_departure_time).toLocaleString()}</p>
                            <p><strong>Passengers:</strong> ${manifest.total_passengers}/${manifest.trip_info.capacity}</p>
                        </div>
                        <h3>Passengers (${manifest.total_bookings} bookings)</h3>
                        ${manifest.passengers.map(p => `
                            <div style="border: 1px solid #e0e0e0; padding: 15px; margin: 10px 0; border-radius: 8px;">
                                <div><strong>${p.passenger_name}</strong> (${p.seat_count} seat${p.seat_count > 1 ? 's' : ''})</div>
                                <div style="font-size: 13px; color: #666; margin-top: 5px;">
                                    <div>üìß ${p.passenger_email}</div>
                                    <div>üì± ${p.passenger_phone}</div>
                                    <div>üé´ ${p.ticket_reference}</div>
                                    <div>üí≥ ‚Ç±${p.total_amount} (${p.booking_type})</div>
                                </div>
                            </div>
                        `).join('')}
                    `;
                }
            } catch (error) {
                content.innerHTML = '<div class="alert alert-error">Error loading manifest</div>';
            }
        }

        async function openReassignVehicle(tripId) {
            document.getElementById('reassignTripId').value = tripId;
            document.getElementById('reassignVehicleModal').classList.add('active');
        }

        async function openReassignDriver(tripId) {
            document.getElementById('reassignDriverTripId').value = tripId;
            document.getElementById('reassignDriverModal').classList.add('active');
        }

        document.getElementById('reassignVehicleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const tripId = document.getElementById('reassignTripId').value;
            const vehicleId = document.getElementById('reassignVehicleSelect').value;

            try {
                const response = await fetch(`${API_URL}/dispatcher/trips/${tripId}/reassign-vehicle`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ vehicle_id: parseInt(vehicleId) })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('‚úÖ Vehicle reassigned successfully!', 'success');
                    closeModal('reassignVehicleModal');
                    loadQueue();
                } else {
                    showAlert(`‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Error reassigning vehicle', 'error');
            }
        });

        document.getElementById('reassignDriverForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const tripId = document.getElementById('reassignDriverTripId').value;
            const driverId = document.getElementById('reassignDriverSelect').value;

            try {
                const response = await fetch(`${API_URL}/dispatcher/trips/${tripId}/reassign-driver`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ driver_id: parseInt(driverId) })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('‚úÖ Driver reassigned successfully!', 'success');
                    closeModal('reassignDriverModal');
                    loadQueue();
                } else {
                    showAlert(`‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Error reassigning driver', 'error');
            }
        });

        async function openCancelBooking(bookingId) {
            currentCancelBookingId = bookingId;
            const content = document.getElementById('cancel-booking-info');
            content.innerHTML = '<div class="loading">Loading booking details...</div>';
            document.getElementById('cancelBookingModal').classList.add('active');

            try {
                const response = await fetch(`${API_URL}/dispatcher/bookings/${bookingId}/passenger-contact`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success) {
                    const b = data.data;
                    content.innerHTML = `
                        <div class="alert alert-error">
                            <strong>‚ö†Ô∏è Warning:</strong> This action will cancel the booking and return the seats to inventory.
                        </div>
                        <div style="padding: 15px; background: #f9f9f9; border-radius: 8px;">
                            <p><strong>Booking ID:</strong> ${b.booking_id}</p>
                            <p><strong>Passenger:</strong> ${b.passenger_name}</p>
                            <p><strong>Email:</strong> ${b.passenger_email}</p>
                            <p><strong>Phone:</strong> ${b.passenger_phone}</p>
                        </div>
                    `;
                }
            } catch (error) {
                content.innerHTML = '<div class="alert alert-error">Error loading booking</div>';
            }
        }

        async function confirmCancelBooking() {
            if (!currentCancelBookingId) return;

            try {
                const response = await fetch(`${API_URL}/dispatcher/bookings/${currentCancelBookingId}/cancel`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('‚úÖ Booking cancelled successfully!', 'success');
                    closeModal('cancelBookingModal');
                    loadActiveBookings();
                    currentCancelBookingId = null;
                } else {
                    showAlert(`‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Error cancelling booking', 'error');
            }
        }

        async function viewPassengerContact(bookingId) {
            const content = document.getElementById('contact-info');
            content.innerHTML = '<div class="loading">Loading...</div>';
            document.getElementById('contactModal').classList.add('active');

            try {
                const response = await fetch(`${API_URL}/dispatcher/bookings/${bookingId}/passenger-contact`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success) {
                    const p = data.data;
                    content.innerHTML = `
                        <div style="padding: 15px; background: #f9f9f9; border-radius: 8px;">
                            <h3>${p.passenger_name}</h3>
                            <p style="margin-top: 10px;"><strong>üìß Email:</strong><br>${p.passenger_email}</p>
                            <p style="margin-top: 10px;"><strong>üì± Phone:</strong><br><a href="tel:${p.passenger_phone}">${p.passenger_phone}</a></p>
                            <p style="margin-top: 10px;"><strong>üìç Address:</strong><br>${p.passenger_address}</p>
                        </div>
                    `;
                }
            } catch (error) {
                content.innerHTML = '<div class="alert alert-error">Error loading contact</div>';
            }
        }

        async function markDeparted(tripId) {
            if (!confirm('Mark this trip as departed? This will advance the queue.')) return;

            try {
                const response = await fetch(`${API_URL}/dispatcher/trips/${tripId}/depart`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('‚úÖ Trip marked as departed! Queue advanced.', 'success');
                    loadQueue();
                } else {
                    showAlert(`‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Error marking trip departed', 'error');
            }
        }

        async function loadResources() {
            try {
                const [drivers, vehicles] = await Promise.all([
                    fetch(`${API_URL}/dispatcher/resources/drivers`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).then(r => r.json()),
                    fetch(`${API_URL}/dispatcher/resources/vehicles`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).then(r => r.json())
                ]);

                if (drivers.success) {
                    document.getElementById('drivers-list').innerHTML = drivers.data.map(d => `
                        <div style="padding: 10px; border: 1px solid #e0e0e0; margin-bottom: 10px; border-radius: 6px;">
                            <strong>${d.driver_name}</strong>
                            <div style="font-size: 12px; color: #666;">
                                <div>Status: <span class="status-badge status-${d.driver_status}">${d.driver_status}</span></div>
                                <div>Trips: ${d.trips_completed}</div>
                            </div>
                        </div>
                    `).join('');
                }

                if (vehicles.success) {
                    document.getElementById('vehicles-list').innerHTML = vehicles.data.map(v => `
                        <div style="padding: 10px; border: 1px solid #e0e0e0; margin-bottom: 10px; border-radius: 6px;">
                            <strong>${v.plate_number}</strong>
                            <div style="font-size: 12px; color: #666;">
                                <div>${v.vehicle_type} (${v.capacity} seats)</div>
                                <div>Status: <span class="status-badge status-${v.vehicle_status}">${v.vehicle_status}</span></div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Load resources error:', error);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>